cmake_minimum_required(VERSION 3.15)
project(llvmaddon)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_POSITION_INDEPENDENT_CODE ON)

# Node Addon API
execute_process(
        COMMAND node -p "require('node-addon-api').include"
        OUTPUT_VARIABLE NODE_ADDON_API_INCLUDE
        OUTPUT_STRIP_TRAILING_WHITESPACE
)

# LLVM
find_package(LLVM REQUIRED CONFIG)

# Add your source files (must include at least one .cpp)
add_library(llvmaddon SHARED
        ${CMAKE_CURRENT_SOURCE_DIR}/src/main.cpp        # main cpp file for Node addon
        ${CMAKE_CURRENT_SOURCE_DIR}/src/emitter/emitter.cpp
        ${CMAKE_CURRENT_SOURCE_DIR}/src/binder/binder.cpp

        ${CMAKE_CURRENT_SOURCE_DIR}/src/emitter/emitter.h
        ${CMAKE_CURRENT_SOURCE_DIR}/src/helpers/helpers.h
        ${CMAKE_CURRENT_SOURCE_DIR}/src/nodes/programs.h
        ${CMAKE_CURRENT_SOURCE_DIR}/src/binder/binder.h
)

# Make .node suffix for Node.js
set_target_properties(llvmaddon PROPERTIES PREFIX "" SUFFIX ".node")

# Include directories
target_include_directories(llvmaddon PRIVATE
        ${LLVM_INCLUDE_DIRS}
        ${NODE_ADDON_API_INCLUDE}   # node-addon-api
        ${CMAKE_CURRENT_SOURCE_DIR}/src
        /Users/brayhandeaza/Documents/dev/projects/yogi/node_modules/node-addon-api
)

# Compile definitions
target_compile_definitions(llvmaddon PRIVATE NAPI_VERSION=8 ${LLVM_DEFINITIONS})

# Link libraries
target_link_libraries(llvmaddon PRIVATE ${LLVM_LIBRARIES})
